var b=Object.defineProperty;var p=(n,e,s)=>e in n?b(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var r=(n,e,s)=>(p(n,typeof e!="symbol"?e+"":e,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))l(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&l(o)}).observe(document,{childList:!0,subtree:!0});function s(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerpolicy&&(i.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?i.credentials="include":t.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(t){if(t.ep)return;t.ep=!0;const i=s(t);fetch(t.href,i)}})();const w=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];class D{constructor(){r(this,"memory");r(this,"display");r(this,"V");r(this,"I");r(this,"DT");r(this,"ST");r(this,"PC");r(this,"SP");r(this,"stack");r(this,"drawFlag");r(this,"loaded");this.memory=new Uint8Array(4096).fill(0),this.display=new Array(64*32).fill(0),this.V=new Uint8Array(16).fill(0),this.I=new Uint16Array(1).fill(0),this.DT=new Uint8Array(1).fill(0),this.ST=new Uint8Array(1).fill(0),this.PC=new Uint16Array(1).fill(512),this.SP=new Uint8Array(1).fill(0),this.stack=new Uint16Array(16).fill(0),this.drawFlag=!1,this.loaded=!0}readSprites(){for(let e=0;e<80;e++)this.memory[e]=w[e]}loadRom(e){for(let s=0;s<e.length;s++)this.memory[512+s]=e[s]}fetch(e,s){let l=new Uint16Array(1);return l[0]=e,l[0]<<=8,l[0]|=s,l}execute(){if(this.loaded===!1)return;let e=this.fetch(this.memory[this.PC[0]],this.memory[this.PC[0]+1]),s=new Uint16Array([e[0]&4095]),l=new Uint8Array([e[0]&15]),t=new Uint8Array([(e[0]&3840)>>8]),i=new Uint8Array([(e[0]&240)>>8]),o=new Uint8Array([e[0]&255]);switch(e[0]&61440){case 0:e[0]===224?(this.drawFlag=!0,this.PC[0]+=2,console.log("0x00E0: CLS")):e[0]===238&&(this.PC[0]=this.stack[this.SP[0]],this.SP[0]-=1,this.PC[0]+=2,console.log("0x00EE: RET"));break;case 4096:console.log("1nnn: JP nnn"),this.PC[0]=s[0];break;case 8192:console.log("2nnn: Call nnn"),this.SP[0]+=1,this.SP[0]>=16?console.log("Error: Stack Overflow"):(this.stack[this.SP[0]]=this.PC[0],this.PC[0]=s[0]);break;case 12288:this.V[t[0]]===o[0]?this.PC[0]+=4:this.PC[0]+=2,console.log("3xkk: SE Vx, kk");break;case 16384:this.V[t[0]]!==o[0]?this.PC[0]+=4:this.PC[0]+=2,console.log("4xkk: SNE Vx, kk");break;case 20480:this.V[t[0]]===this.V[i[0]]?this.PC[0]+=4:this.PC[0]+=2,console.log("5xy0: Se Vx, Vy");break;case 24576:this.V[t[0]]=o[0],this.PC[0]+=2,console.log("6xkk: LD Vx, kk ",o[0].toString(16));break;case 28672:this.V[t[0]]+=o[0],this.PC[0]+=2,console.log("7xkk: ADD Vx, kk",o[0].toString(16));break;case 32768:switch(l[0]){case 0:this.V[t[0]]=this.V[i[0]],this.PC[0]+=2,console.log("8xy0: LD Vx, Vy");break;case 1:this.V[t[0]]|=this.V[i[0]],this.PC[0]+=2,console.log("8xy1: OR Vx, Vy");break;case 2:this.V[t[0]]&=this.V[i[0]],this.PC[0]+=2,console.log("8x02: AND Vx, Vy");break;case 3:this.V[t[0]]^=this.V[i[0]],this.PC[0]+=2,console.log("8xy3: XOR Vx, Vy");break;case 4:this.V[t[0]]+=this.V[i[0]],this.V[t[0]]>255?this.V[15]=1:this.V[15]=0,this.PC[0]+=2,console.log("8xy4: ADD Vx, Vy");break;case 5:this.V[t[0]]>this.V[i[0]]?this.V[15]=1:this.V[15]=0,this.V[t[0]]-=this.V[i[0]],this.PC[0]+=2,console.log("8xy5: SUB Vx, Vy");break;case 6:(this.V[t[0]]&1)===1&&(this.V[15]=1),this.V[t[0]]>>=1,this.PC[0]+=2,console.log("8xy6: SHR Vx {, Vy}");break;case 7:this.V[i[0]]>this.V[t[0]]?this.V[15]=1:this.V[15]=0,this.V[t[0]]=this.V[i[0]]-this.V[t[0]],this.PC[0]+=2,console.log("8xy7: SUBN Vx, Vy");break;case 14:this.V[t[0]]>>7===1?this.V[15]=1:this.V[15]=0,this.V[t[0]]<<=1,this.PC[0]+=2,console.log("8xyE: SHL Vx {, Vy}");break;default:console.log("INVALID OPCODE REEEEEEEEEEEEEEE (its fine)");break}break;case 36864:this.V[t[0]]!==this.V[i[0]]?this.PC[0]+=4:this.PC[0]+=2,console.log("9xy0: SNE Vx, Vy");break;case 40960:this.I[0]=s[0],this.PC[0]+=2,console.log("Annn: LD I, nnn ",s[0].toString(16),this.I[0].toString(16));break;case 45056:this.PC[0]=s[0]+this.V[0],console.log("Bnnn: JP V0, nnn");break;case 49152:let d=Math.random()*255;this.V[t[0]]=d&o[0],this.PC[0]+=2,console.log("Cxkk: RND Vx, kk");break;case 53248:const f=e[0]&15,k=(e[0]&3840)>>8,m=(e[0]&240)>>4;this.V[15]=0;for(let c=0;c<f;c++){const P=this.memory[this.I[0]+c];for(let V=0;V<8;V++){if(!(P&128>>V))continue;const E=(this.V[k]+V)%64,C=(this.V[m]+c)%32,g=E+C*64;this.display[g]!==0&&(this.V[15]=1),this.display[g]^=1}}this.drawFlag=!0,this.PC[0]+=2,console.log("Dxyn: DRW Vx, Vy, nibble ",l[0].toString(16));break;case 57344:o[0]===158?(this.PC[0]+=2,console.log("Ex9E: SKP Vx")):o[0]===161&&(this.PC[0]+=2,console.log("ExA1: SKNP Vx"));break;case 61440:switch(o[0]){case 7:this.V[t[0]]=this.DT[0],this.PC[0]+=2,console.log("Fx07: LD Vx, DT");break;case 10:this.PC[0]+=2,console.log("Fx0A: LD Vx, K");break;case 21:this.DT[0]=this.V[t[0]],this.PC[0]+=2,console.log("Fx15: LD DT, Vx");break;case 24:this.ST[0]=this.V[t[0]],this.PC[0]+=2,console.log("Fx18: LD St, Vx");break;case 30:this.I[0]+=this.V[t[0]],this.PC[0]+=2,console.log("Fx1E: ADD I, Vx");break;case 41:this.I[0]=this.V[t[0]]*5,this.PC[0]+=2,console.log("Fx29: LD F, Vx");break;case 51:console.log("Fx33: LD B, Vx");break;case 85:console.log("Fx55: LD [I], Vx");break;case 101:console.log("Fx65: LD Vx, [I]");break;default:console.log("INVALID OPCODE REEEEEEEEEEEEEEE (its fine)",e[0].toString(16));break}break;default:console.log("False flag")}}getDisplay(){return this.display}getDrawFlag(){return this.drawFlag}setDrawFlag(e){this.drawFlag=e}getLoaded(){return this.loaded}setLoaded(e){this.loaded=e}}class S{constructor(e,s){r(this,"canvas");r(this,"context");this.canvas=document.querySelector("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=e,this.canvas.height=s}render(e){this.context.fillStyle="black",this.context.fillRect(0,0,this.canvas.width,this.canvas.height);const s=this.canvas.height/32;this.context.fillStyle="white";const l=e;for(let t=0;t<l.length;t++){const i=Math.floor(t/64),o=t%64;if(l[t]!==0){const d=o*s,f=i*s;this.context.fillRect(d,f,s,s)}}}}class A{constructor(){r(this,"roms");r(this,"romNames");this.roms=new Array,this.romNames=new Array}readRomInput(e){let s=new FileReader;s.onload=()=>{this.roms.push(new Uint8Array(s.result)),this.romNames.push("")},s.readAsArrayBuffer(e)}readExistingRom(){let e=new XMLHttpRequest;e.onload=()=>{e.response&&(this.roms.push(new Uint8Array(e.response)),this.romNames.push(""))},e.open("GET","IBM.ch8"),e.responseType="arraybuffer",e.send()}getIBMRom(){return this.roms[0]}getRomsLength(){return this.roms.length}}let y=new S(1280,640),a=new D,h=new A;y.render(new Array(2048).fill(0));let L=document.getElementById("files"),I=document.getElementById("start");function x(){if(h.getRomsLength()!==0){a.loadRom(h.getIBMRom()),a.setLoaded(!0);return}x()}h.readExistingRom();a.setLoaded(!0);L.addEventListener("change",n=>{let e=n.target.files[0];h.readRomInput(e),setTimeout(()=>{x()},1)});function u(){a.execute(),a.getDrawFlag()===!0&&(y.render(a.getDisplay()),a.setDrawFlag(!1)),setTimeout(()=>{u()},1)}I.addEventListener("click",n=>{n.preventDefault(),a.getLoaded()===!0&&(a.loadRom(h.getIBMRom()),u())});
